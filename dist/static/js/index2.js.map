{"version":3,"file":"index2.js","sources":["../../../src/views/able/video-frame/canvasRenderer.ts","../../../src/views/able/video-frame/index.vue"],"sourcesContent":["// import { throttle } from \"@pureadmin/utils\";\nimport { emitter } from \"@/utils/mitt\";\n\nexport class CanvasRenderer {\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n  private images: {\n    img: HTMLImageElement;\n    x: number;\n    y: number;\n    width: number;\n    height: number;\n  }[];\n  private container: HTMLElement;\n  private positionX: number;\n  private isDragging: boolean;\n  private startX: number;\n\n  constructor(containerId: string) {\n    this.canvas = document.createElement(\"canvas\");\n    this.ctx = this.canvas.getContext(\"2d\")!;\n    this.images = [];\n    this.positionX = 0;\n    this.isDragging = false;\n    this.startX = 0;\n\n    this.container = document.getElementById(containerId);\n    if (this.container) {\n      this.container.appendChild(this.canvas);\n      this.canvas.width = this.container.clientWidth;\n      this.canvas.height = this.container.clientHeight;\n    }\n  }\n\n  public addImage(\n    url: string,\n    x: number,\n    y: number,\n    width: number,\n    height: number\n  ) {\n    const img = new Image();\n    img.src = url;\n\n    this.images.push({\n      img,\n      x,\n      y,\n      width,\n      height\n    });\n\n    this.render();\n  }\n\n  public render() {\n    this.clearRect();\n\n    this.images.forEach(imgProps => {\n      const x = imgProps.x + this.positionX;\n      this.ctx.drawImage(\n        imgProps.img,\n        x,\n        imgProps.y,\n        imgProps.width,\n        imgProps.height\n      );\n    });\n  }\n\n  public clearImages() {\n    this.images = [];\n  }\n\n  public clearRect() {\n    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n  }\n\n  public drawTick(event) {\n    this.render();\n\n    // 当前勾选图片的索引\n    const index =\n      Math.ceil(\n        (Math.abs(this.positionX) + event.offsetX) / this.images[0].width\n      ) - 1;\n    const x = event.offsetX;\n    const y = event.offsetY;\n\n    // 绘制样式\n    this.ctx.strokeStyle = \"red\";\n    this.ctx.lineWidth = 4;\n    this.ctx.lineCap = \"round\";\n\n    // 绘制对勾\n    this.ctx.beginPath();\n    this.ctx.moveTo(x - 10, y);\n    this.ctx.lineTo(x, y + 10);\n    this.ctx.lineTo(x + 15, y - 10);\n    this.ctx.stroke();\n\n    emitter.emit(\"imageInfo\", this.images[index]);\n  }\n\n  public addListener() {\n    if (!this.canvas) return;\n    this.canvas.addEventListener(\"click\", this.handleClick);\n    this.canvas.addEventListener(\"mousedown\", this.handleMouseDown);\n    this.canvas.addEventListener(\"mousemove\", this.handleMouseMove);\n    this.canvas.addEventListener(\"mouseup\", this.handleMouseUp);\n    this.canvas.addEventListener(\"touchstart\", this.handleTouchStart);\n    this.canvas.addEventListener(\"touchmove\", this.handleTouchMove);\n    this.canvas.addEventListener(\"touchend\", this.handleTouchEnd);\n    // window.addEventListener(\"resize\", throttle(this.handleWindowResize, 200));\n  }\n\n  private handleClick = (event: MouseEvent) => {\n    this.drawTick(event);\n  };\n\n  private handleMouseDown = (event: MouseEvent) => {\n    this.startDrag(event.clientX);\n  };\n\n  private handleMouseMove = (event: MouseEvent) => {\n    this.drag(event.clientX);\n  };\n\n  private handleMouseUp = () => {\n    this.endDrag();\n  };\n\n  private handleTouchStart = (event: TouchEvent) => {\n    if (event.touches.length === 1) {\n      event.preventDefault();\n      this.startDrag(event.touches[0].clientX);\n    }\n  };\n\n  private handleTouchMove = (event: TouchEvent) => {\n    if (event.touches.length === 1) {\n      event.preventDefault();\n      this.drag(event.touches[0].clientX);\n    }\n  };\n\n  private handleTouchEnd = () => {\n    this.endDrag();\n  };\n\n  private startDrag(clientX: number) {\n    this.canvas.style.cursor = \"grabbing\";\n    this.canvas.style.userSelect = \"none\";\n\n    this.startX = clientX;\n    this.isDragging = true;\n  }\n\n  private drag(clientX: number) {\n    if (!this.isDragging) return;\n\n    const deltaX = clientX - this.startX;\n    const maxPositionX =\n      this.images.length * this.images[0].width - this.container.clientWidth;\n    this.positionX = Math.max(\n      Math.min(this.positionX + deltaX, 0),\n      -maxPositionX\n    );\n    this.startX = clientX;\n\n    this.render();\n  }\n\n  private endDrag() {\n    this.canvas.style.cursor = \"grab\";\n    this.canvas.style.userSelect = \"auto\";\n    this.isDragging = false;\n  }\n\n  // private handleWindowResize = () => {\n  //   this.canvas.width = this.container.clientWidth;\n  //   this.canvas.height = this.container.clientHeight;\n  //   this.render();\n  // };\n}\n","<script setup lang=\"ts\">\nimport { emitter } from \"@/utils/mitt\";\nimport { useLoader } from \"@pureadmin/utils\";\nimport { CanvasRenderer } from \"./canvasRenderer\";\nimport { ref, onMounted, onBeforeUnmount } from \"vue\";\n\ndefineOptions({\n  name: \"VideoFrame\"\n});\n\nconst num = 200;\nconst curImg = ref(\"\");\nconst renderer = ref();\nconst captureUtil = ref();\nconst loading = ref(false);\nconst { loadScript } = useLoader();\n\nconst { VITE_PUBLIC_PATH } = import.meta.env;\nconst getPath = path => `${VITE_PUBLIC_PATH}wasm/${path}`;\nconst src = getPath(\"index.js\");\nconst workerPath = getPath(\"capture.worker.js\");\nconst wasmPath = getPath(\"capture.worker.wasm\");\n\nloadScript({\n  src\n}).then(mgs => {\n  if (mgs === \"success\") {\n    // @ts-expect-error\n    captureUtil.value = cheetahCapture.initCapture({\n      workerPath,\n      wasmPath\n    });\n  }\n});\n\nonMounted(() => {\n  renderer.value = new CanvasRenderer(\"canvas-container\");\n  emitter.on(\"imageInfo\", info => (curImg.value = info.img.src));\n});\n\nfunction beforeUpload(file) {\n  curImg.value = \"\";\n  loading.value = true;\n  renderer.value.clearImages();\n  // api参考 https://github.com/wanwu/cheetah-capture#api\n  captureUtil.value.then(res => {\n    res.capture({\n      // 视频文件\n      file,\n      // 抽取指定数目的帧图片，传递`number`是按照数目抽帧，传递数组是指定抽帧的时间，单位毫秒（抽帧策略：https://github.com/wanwu/cheetah-capture/issues/6#issuecomment-1634384486）\n      info: 16,\n      // 当抽帧结果变化的回调\n      onChange: (list, { url }) => {\n        renderer.value.addImage(url, num * list.url.length, 0, num, num);\n      },\n      // 当抽帧结束并成功的回调\n      onSuccess: () => {\n        renderer.value.addListener();\n        // 默认选中第一张\n        renderer.value.drawTick({ offsetX: num / 2, offsetY: num / 2 });\n        loading.value = false;\n      },\n      // 当抽帧过程出现错误的回调\n      onError: () => {\n        loading.value = false;\n      }\n    });\n  });\n\n  return false;\n}\n\nonBeforeUnmount(() => {\n  // 解绑`imageInfo`公共事件，防止多次触发\n  emitter.off(\"imageInfo\");\n});\n</script>\n\n<template>\n  <el-card shadow=\"never\">\n    <template #header>\n      <div class=\"card-header\">\n        <span class=\"font-medium\">\n          <p>\n            基于自定义编译\n            <el-link\n              href=\"https://github.com/FFmpeg/FFmpeg\"\n              target=\"_blank\"\n              style=\"margin: 0 4px 5px; font-size: 16px\"\n            >\n              FFmpeg\n            </el-link>\n            的截帧工具，支持MP4、MOV、AVI、WebM、MKV等主流格式，支持\n            H.264（AVC）、H.265（HEVC）、MPEG-2、MPEG-4、VP8、VP9、WMV3编码格式\n          </p>\n          当然还可以支持更多视频格式，只要FFmpeg支持的，按理都能支持，您也可参考\n          <el-link\n            href=\"https://github.com/wanwu/cheetah-capture\"\n            target=\"_blank\"\n            style=\"margin: 0 4px 5px; font-size: 16px\"\n          >\n            cheetah-capture\n          </el-link>\n          和\n          <el-link\n            href=\"https://github.com/jordiwang/web-capture\"\n            target=\"_blank\"\n            style=\"margin: 0 4px 5px; font-size: 16px\"\n          >\n            web-capture\n          </el-link>\n          修改并编译wasm等文件（强烈推荐在Ubuntu系统进行编译）\n          <p>\n            mac系统推荐安装\n            <el-link\n              href=\"https://github.com/utmapp/UTM\"\n              target=\"_blank\"\n              style=\"margin: 0 4px 5px; font-size: 16px\"\n            >\n              UTM\n            </el-link>\n            虚拟机，windows系统推荐安装VMware虚拟机\n          </p>\n          <p>\n            当然这只是一个视频帧截取工具，如果您想要更多操作可以研究下\n            <el-link\n              href=\"https://ffmpegwasm.netlify.app/\"\n              target=\"_blank\"\n              style=\"margin: 0 4px 5px; font-size: 16px\"\n            >\n              ffmpeg.wasm\n            </el-link>\n            ，它是基于 FFmpeg 的纯 WebAssembly / JavaScript\n            工具，可以在浏览器内进行视频和音频录制、转换和流式传输等，不过通过一些实践，对于时长较长的视频性能还是不太行，不过用于时长较短的短视频还是可以上生产的\n          </p>\n        </span>\n      </div>\n    </template>\n    <div class=\"flex flex-wrap\">\n      <el-upload\n        drag\n        :show-file-list=\"false\"\n        accept=\".mp4,.mov,.avi,.webm,.mkv\"\n        :before-upload=\"beforeUpload\"\n      >\n        <div class=\"el-upload__text\">\n          可拖拽上传视频（默认截取16张帧图片，可在代码中自行修改）\n        </div>\n      </el-upload>\n      <el-image\n        v-if=\"curImg\"\n        :src=\"curImg\"\n        :preview-src-list=\"Array.of(curImg)\"\n        class=\"w-[180px] h-[180px] ml-2 rounded-[6px]\"\n      />\n    </div>\n    <div\n      v-loading=\"loading\"\n      element-loading-text=\"温馨提示：可左右拖拽图片并单击选取所需的帧图片\"\n      id=\"canvas-container\"\n      class=\"w-full h-[200px] overflow-hidden mt-6\"\n    />\n  </el-card>\n</template>\n\n<style scoped lang=\"scss\">\n::v-deep(.el-upload-dragger) {\n  display: flex;\n  align-items: center;\n  height: 180px;\n}\n</style>\n"],"names":["CanvasRenderer","containerId","__publicField","event","url","x","y","width","height","img","imgProps","index","emitter","clientX","deltaX","maxPositionX","num","curImg","ref","renderer","captureUtil","loading","loadScript","useLoader","VITE_PUBLIC_PATH","getPath","path","src","workerPath","wasmPath","mgs","onMounted","info","beforeUpload","file","res","list","onBeforeUnmount"],"mappings":"uVAGO,MAAMA,CAAe,CAe1B,YAAYC,EAAqB,CAdzBC,EAAA,eACAA,EAAA,YACAA,EAAA,eAOAA,EAAA,kBACAA,EAAA,kBACAA,EAAA,mBACAA,EAAA,eAoGAA,EAAA,mBAAeC,GAAsB,CAC3C,KAAK,SAASA,CAAK,CAAA,GAGbD,EAAA,uBAAmBC,GAAsB,CAC1C,KAAA,UAAUA,EAAM,OAAO,CAAA,GAGtBD,EAAA,uBAAmBC,GAAsB,CAC1C,KAAA,KAAKA,EAAM,OAAO,CAAA,GAGjBD,EAAA,qBAAgB,IAAM,CAC5B,KAAK,QAAQ,CAAA,GAGPA,EAAA,wBAAoBC,GAAsB,CAC5CA,EAAM,QAAQ,SAAW,IAC3BA,EAAM,eAAe,EACrB,KAAK,UAAUA,EAAM,QAAQ,CAAC,EAAE,OAAO,EACzC,GAGMD,EAAA,uBAAmBC,GAAsB,CAC3CA,EAAM,QAAQ,SAAW,IAC3BA,EAAM,eAAe,EACrB,KAAK,KAAKA,EAAM,QAAQ,CAAC,EAAE,OAAO,EACpC,GAGMD,EAAA,sBAAiB,IAAM,CAC7B,KAAK,QAAQ,CAAA,GAhIR,KAAA,OAAS,SAAS,cAAc,QAAQ,EAC7C,KAAK,IAAM,KAAK,OAAO,WAAW,IAAI,EACtC,KAAK,OAAS,GACd,KAAK,UAAY,EACjB,KAAK,WAAa,GAClB,KAAK,OAAS,EAET,KAAA,UAAY,SAAS,eAAeD,CAAW,EAChD,KAAK,YACF,KAAA,UAAU,YAAY,KAAK,MAAM,EACjC,KAAA,OAAO,MAAQ,KAAK,UAAU,YAC9B,KAAA,OAAO,OAAS,KAAK,UAAU,aAExC,CAEO,SACLG,EACAC,EACAC,EACAC,EACAC,EACA,CACM,MAAAC,EAAM,IAAI,MAChBA,EAAI,IAAML,EAEV,KAAK,OAAO,KAAK,CACf,IAAAK,EACA,EAAAJ,EACA,EAAAC,EACA,MAAAC,EACA,OAAAC,CAAA,CACD,EAED,KAAK,OAAO,CACd,CAEO,QAAS,CACd,KAAK,UAAU,EAEV,KAAA,OAAO,QAAoBE,GAAA,CACxB,MAAAL,EAAIK,EAAS,EAAI,KAAK,UAC5B,KAAK,IAAI,UACPA,EAAS,IACTL,EACAK,EAAS,EACTA,EAAS,MACTA,EAAS,MAAA,CACX,CACD,CACH,CAEO,aAAc,CACnB,KAAK,OAAS,EAChB,CAEO,WAAY,CACZ,KAAA,IAAI,UAAU,EAAG,EAAG,KAAK,OAAO,MAAO,KAAK,OAAO,MAAM,CAChE,CAEO,SAASP,EAAO,CACrB,KAAK,OAAO,EAGZ,MAAMQ,EACJ,KAAK,MACF,KAAK,IAAI,KAAK,SAAS,EAAIR,EAAM,SAAW,KAAK,OAAO,CAAC,EAAE,KAC1D,EAAA,EACAE,EAAIF,EAAM,QACVG,EAAIH,EAAM,QAGhB,KAAK,IAAI,YAAc,MACvB,KAAK,IAAI,UAAY,EACrB,KAAK,IAAI,QAAU,QAGnB,KAAK,IAAI,YACT,KAAK,IAAI,OAAOE,EAAI,GAAIC,CAAC,EACzB,KAAK,IAAI,OAAOD,EAAGC,EAAI,EAAE,EACzB,KAAK,IAAI,OAAOD,EAAI,GAAIC,EAAI,EAAE,EAC9B,KAAK,IAAI,SAETM,EAAQ,KAAK,YAAa,KAAK,OAAOD,CAAK,CAAC,CAC9C,CAEO,aAAc,CACd,KAAK,SACV,KAAK,OAAO,iBAAiB,QAAS,KAAK,WAAW,EACtD,KAAK,OAAO,iBAAiB,YAAa,KAAK,eAAe,EAC9D,KAAK,OAAO,iBAAiB,YAAa,KAAK,eAAe,EAC9D,KAAK,OAAO,iBAAiB,UAAW,KAAK,aAAa,EAC1D,KAAK,OAAO,iBAAiB,aAAc,KAAK,gBAAgB,EAChE,KAAK,OAAO,iBAAiB,YAAa,KAAK,eAAe,EAC9D,KAAK,OAAO,iBAAiB,WAAY,KAAK,cAAc,EAE9D,CAoCQ,UAAUE,EAAiB,CAC5B,KAAA,OAAO,MAAM,OAAS,WACtB,KAAA,OAAO,MAAM,WAAa,OAE/B,KAAK,OAASA,EACd,KAAK,WAAa,EACpB,CAEQ,KAAKA,EAAiB,CAC5B,GAAI,CAAC,KAAK,WAAY,OAEhB,MAAAC,EAASD,EAAU,KAAK,OACxBE,EACJ,KAAK,OAAO,OAAS,KAAK,OAAO,CAAC,EAAE,MAAQ,KAAK,UAAU,YAC7D,KAAK,UAAY,KAAK,IACpB,KAAK,IAAI,KAAK,UAAYD,EAAQ,CAAC,EACnC,CAACC,CAAA,EAEH,KAAK,OAASF,EAEd,KAAK,OAAO,CACd,CAEQ,SAAU,CACX,KAAA,OAAO,MAAM,OAAS,OACtB,KAAA,OAAO,MAAM,WAAa,OAC/B,KAAK,WAAa,EACpB,CAOF,oUC9KMG,EAAM,mDACN,MAAAC,EAASC,EAAI,EAAE,EACfC,EAAWD,IACXE,EAAcF,IACdG,EAAUH,EAAI,EAAK,EACnB,CAAE,WAAAI,GAAeC,IAEjB,CAAE,iBAAAC,CAAiB,EAAI,sNACvBC,EAAUC,GAAQ,GAAGF,CAAgB,QAAQE,CAAI,GACjDC,EAAMF,EAAQ,UAAU,EACxBG,EAAaH,EAAQ,mBAAmB,EACxCI,EAAWJ,EAAQ,qBAAqB,EAEnCH,EAAA,CACT,IAAAK,CAAA,CACD,EAAE,KAAYG,GAAA,CACTA,IAAQ,YAEEV,EAAA,MAAQ,eAAe,YAAY,CAC7C,WAAAQ,EACA,SAAAC,CAAA,CACD,EACH,CACD,EAEDE,EAAU,IAAM,CACLZ,EAAA,MAAQ,IAAInB,EAAe,kBAAkB,EACtDY,EAAQ,GAAG,YAAaoB,GAASf,EAAO,MAAQe,EAAK,IAAI,GAAI,CAAA,CAC9D,EAED,SAASC,EAAaC,EAAM,CAC1B,OAAAjB,EAAO,MAAQ,GACfI,EAAQ,MAAQ,GAChBF,EAAS,MAAM,cAEHC,EAAA,MAAM,KAAYe,GAAA,CAC5BA,EAAI,QAAQ,CAEV,KAAAD,EAEA,KAAM,GAEN,SAAU,CAACE,EAAM,CAAE,IAAAhC,KAAU,CAClBe,EAAA,MAAM,SAASf,EAAKY,EAAMoB,EAAK,IAAI,OAAQ,EAAGpB,EAAKA,CAAG,CACjE,EAEA,UAAW,IAAM,CACfG,EAAS,MAAM,cAENA,EAAA,MAAM,SAAS,CAAE,QAASH,EAAM,EAAG,QAASA,EAAM,CAAA,CAAG,EAC9DK,EAAQ,MAAQ,EAClB,EAEA,QAAS,IAAM,CACbA,EAAQ,MAAQ,EAClB,CAAA,CACD,CAAA,CACF,EAEM,EACT,CAEA,OAAAgB,EAAgB,IAAM,CAEpBzB,EAAQ,IAAI,WAAW,CAAA,CACxB"}